{% extends "dashboard/roles/vendeur/base_vendeur.html" %}
{% load static %}

{% block title %}Mes Ventes - Vendeur - Walee{% endblock %}

{% block dashboard_content %}
<div x-data="mesVentesData()" x-init="init()">
    
    <!-- Header Compact -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold font-poppins text-gray-900 dark:text-white">
                Mes Ventes
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                <span x-text="filteredVentes.length"></span> vente(s) - <span x-text="getPeriodLabel()"></span>
            </p>
        </div>
        
        <div class="flex items-center gap-2">
            <select x-model="selectedPeriod" 
                    @change="filterVentes()" 
                    class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition">
                <option value="today">Aujourd'hui</option>
                <option value="week">Cette semaine</option>
                <option value="month">Ce mois</option>
                <option value="all">Tout</option>
            </select>
            <button @click="exportVentes()" 
                    class="px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-1.5">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span class="hidden sm:inline">Exporter</span>
            </button>
        </div>
    </div>

    <!-- Stats KPI - Version Compacte -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
        <div class="group bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/20 rounded-lg p-4 border border-green-200 dark:border-green-700 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs font-medium text-green-700 dark:text-green-300 uppercase tracking-wide">CA Réalisé</p>
                <div class="w-8 h-8 bg-green-100 dark:bg-green-900/50 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i data-lucide="dollar-sign" class="w-4 h-4 text-green-600"></i>
                </div>
            </div>
            <p class="text-xl font-bold text-green-900 dark:text-green-100" x-text="formatMoney(stats.caTotal)"></p>
            <div class="mt-2 flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
                <i data-lucide="trending-up" class="w-3 h-3"></i>
                <span>+12% vs hier</span>
            </div>
        </div>

        <div class="group bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/20 rounded-lg p-4 border border-blue-200 dark:border-blue-700 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs font-medium text-blue-700 dark:text-blue-300 uppercase tracking-wide">Ventes</p>
                <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/50 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i data-lucide="shopping-bag" class="w-4 h-4 text-blue-600"></i>
                </div>
            </div>
            <p class="text-xl font-bold text-blue-900 dark:text-blue-100" x-text="stats.nombreVentes"></p>
            <div class="mt-2 flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400">
                <i data-lucide="package" class="w-3 h-3"></i>
                <span x-text="stats.articlesVendus + ' articles'"></span>
            </div>
        </div>

        <div class="group bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/20 rounded-lg p-4 border border-purple-200 dark:border-purple-700 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs font-medium text-purple-700 dark:text-purple-300 uppercase tracking-wide">Panier Moyen</p>
                <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900/50 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i data-lucide="trending-up" class="w-4 h-4 text-purple-600"></i>
                </div>
            </div>
            <p class="text-xl font-bold text-purple-900 dark:text-purple-100" x-text="formatMoney(stats.panierMoyen)"></p>
            <div class="mt-2 flex items-center gap-1 text-xs text-purple-600 dark:text-purple-400">
                <i data-lucide="bar-chart-2" class="w-3 h-3"></i>
                <span>Objectif: 100k</span>
            </div>
        </div>

        <div class="group bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/30 dark:to-orange-800/20 rounded-lg p-4 border border-orange-200 dark:border-orange-700 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs font-medium text-orange-700 dark:text-orange-300 uppercase tracking-wide">Commission</p>
                <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900/50 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i data-lucide="wallet" class="w-4 h-4 text-orange-600"></i>
                </div>
            </div>
            <p class="text-xl font-bold text-orange-900 dark:text-orange-100" x-text="formatMoney(stats.commission)"></p>
            <div class="mt-2 flex items-center gap-1 text-xs text-orange-600 dark:text-orange-400">
                <i data-lucide="percent" class="w-3 h-3"></i>
                <span x-text="stats.tauxCommission + '%'"></span>
            </div>
        </div>
    </div>

    <!-- Filtres Compacts -->
    <div class="bg-white dark:bg-gray-800 rounded-lg p-3 mb-4 shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="flex flex-col sm:flex-row gap-2">
            <div class="flex-1 relative">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" 
                       x-model="searchQuery"
                       @input="filterVentes()"
                       placeholder="Rechercher par N° ou client..."
                       class="w-full pl-9 pr-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent transition">
            </div>
            <select x-model="filterStatut" 
                    @change="filterVentes()" 
                    class="px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent transition">
                <option value="">Tous les statuts</option>
                <option value="payee">✓ Payée</option>
                <option value="attente">⏳ En attente</option>
                <option value="annulee">✗ Annulée</option>
            </select>
            <button @click="resetFilters()" 
                    x-show="searchQuery || filterStatut"
                    class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center gap-1.5">
                <i data-lucide="x" class="w-3.5 h-3.5"></i>
                <span>Réinitialiser</span>
            </button>
        </div>
    </div>

    <!-- Liste des Ventes - Table Responsive -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <!-- Version Desktop/Tablet -->
        <div class="hidden sm:block overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-900/50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">N° Vente</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Client</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Montant</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Statut</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="vente in filteredVentes" :key="vente.id">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <td class="px-4 py-3">
                                <span class="font-semibold text-green-600 dark:text-green-400 text-sm" x-text="vente.numero"></span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300 whitespace-nowrap" x-text="vente.date"></td>
                            <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300" x-text="vente.client"></td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-bold text-sm text-gray-900 dark:text-white" x-text="formatMoney(vente.montant)"></span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold"
                                      :class="getStatutClass(vente.statut)">
                                    <span x-text="vente.statut"></span>
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center justify-center gap-1">
                                    <button @click="viewVente(vente)" 
                                            class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
                                            title="Voir détails">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    <button @click="printVente(vente)" 
                                            class="p-1.5 text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                            title="Imprimer">
                                        <i data-lucide="printer" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Version Mobile - Cards -->
        <div class="sm:hidden divide-y divide-gray-200 dark:divide-gray-700">
            <template x-for="vente in filteredVentes" :key="vente.id">
                <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <span class="font-bold text-green-600 dark:text-green-400" x-text="vente.numero"></span>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5" x-text="vente.date"></p>
                        </div>
                        <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold"
                              :class="getStatutClass(vente.statut)">
                            <span x-text="vente.statut"></span>
                        </span>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="user" class="w-4 h-4 text-gray-400"></i>
                        <span class="text-sm text-gray-700 dark:text-gray-300" x-text="vente.client"></span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="dollar-sign" class="w-4 h-4 text-gray-400"></i>
                            <span class="font-bold text-gray-900 dark:text-white" x-text="formatMoney(vente.montant)"></span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button @click="viewVente(vente)" 
                                    class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button @click="printVente(vente)" 
                                    class="p-2 text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                <i data-lucide="printer" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Message si aucun résultat -->
        <div x-show="filteredVentes.length === 0" class="p-8 text-center">
            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="inbox" class="w-8 h-8 text-gray-400"></i>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Aucune vente trouvée</p>
            <button @click="resetFilters()" 
                    class="mt-3 text-sm text-green-600 hover:text-green-700 font-medium">
                Réinitialiser les filtres
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="showToast" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         class="fixed bottom-4 right-4 z-50 bg-white dark:bg-gray-800 rounded-lg shadow-xl border-l-4 border-green-500 p-4 max-w-sm">
        <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                <i data-lucide="check" class="w-5 h-5 text-green-600"></i>
            </div>
            <div class="flex-1">
                <p class="text-sm font-semibold text-gray-900 dark:text-white" x-text="toastMessage"></p>
            </div>
            <button @click="showToast = false" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function mesVentesData() {
    return {
        selectedPeriod: 'today',
        searchQuery: '',
        filterStatut: '',
        showToast: false,
        toastMessage: '',
        
        stats: {
            caTotal: 2800000,
            nombreVentes: 32,
            panierMoyen: 87500,
            commission: 140000,
            articlesVendus: 156,
            tauxCommission: 5
        },
        
        ventes: [
            { id: 1, numero: 'VNT-001', date: '20/10/2025 14:30', client: 'Entreprise A', montant: 250000, statut: 'Payée' },
            { id: 2, numero: 'VNT-002', date: '20/10/2025 11:15', client: 'Client B', montant: 180000, statut: 'Payée' },
            { id: 3, numero: 'VNT-003', date: '19/10/2025 16:45', client: 'Société C', montant: 95000, statut: 'En attente' },
            { id: 4, numero: 'VNT-004', date: '19/10/2025 09:20', client: 'Client D', montant: 320000, statut: 'Payée' },
            { id: 5, numero: 'VNT-005', date: '18/10/2025 15:00', client: 'Entreprise E', montant: 150000, statut: 'Annulée' },
            { id: 6, numero: 'VNT-006', date: '18/10/2025 10:30', client: 'Client F', montant: 275000, statut: 'Payée' },
            { id: 7, numero: 'VNT-007', date: '17/10/2025 13:45', client: 'Société G', montant: 420000, statut: 'Payée' },
            { id: 8, numero: 'VNT-008', date: '17/10/2025 08:15', client: 'Entreprise H', montant: 190000, statut: 'En attente' }
        ],
        
        get filteredVentes() {
            let result = this.ventes;
            
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                result = result.filter(v => 
                    v.numero.toLowerCase().includes(query) ||
                    v.client.toLowerCase().includes(query)
                );
            }
            
            if (this.filterStatut) {
                result = result.filter(v => v.statut.toLowerCase().includes(this.filterStatut));
            }
            
            return result;
        },
        
        init() {
            lucide.createIcons();
        },
        
        filterVentes() {
            this.$nextTick(() => lucide.createIcons());
        },
        
        resetFilters() {
            this.searchQuery = '';
            this.filterStatut = '';
            this.toast('Filtres réinitialisés');
        },
        
        getPeriodLabel() {
            const labels = {
                'today': 'Aujourd\'hui',
                'week': 'Cette semaine',
                'month': 'Ce mois',
                'all': 'Toutes les périodes'
            };
            return labels[this.selectedPeriod] || '';
        },
        
        getStatutClass(statut) {
            const classes = {
                'Payée': 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300',
                'En attente': 'bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300',
                'Annulée': 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300'
            };
            return classes[statut] || 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
        },
        
        viewVente(vente) {
            this.toast(`Ouverture de ${vente.numero}`);
            // Redirection ou modal ici
        },
        
        printVente(vente) {
            this.toast(`Impression de ${vente.numero} en cours...`);
        },
        
        exportVentes() {
            this.toast(`Export de ${this.filteredVentes.length} vente(s) en cours...`);
        },
        
        toast(message) {
            this.toastMessage = message;
            this.showToast = true;
            this.$nextTick(() => lucide.createIcons());
            
            setTimeout(() => {
                this.showToast = false;
            }, 3000);
        },
        
        formatMoney(amount) {
            if (!amount && amount !== 0) return '0 FCFA';
            return new Intl.NumberFormat('fr-FR', { 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0 
            }).format(amount) + ' FCFA';
        }
    }
}
</script>
{% endblock %}