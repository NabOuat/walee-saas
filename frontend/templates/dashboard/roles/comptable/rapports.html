{% extends "dashboard/roles/comptable/base_comptable.html" %}
{% load static %}

{% block title %}Rapports Financiers - Comptable - Walee{% endblock %}

{% block dashboard_content %}
<div x-data="rapportsData()" x-init="init()">
    
    <!-- Header Compact -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold font-poppins text-gray-900 dark:text-white">
                Rapports Financiers
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Bilan et compte de résultat - Exercice <span x-text="selectedPeriod" class="font-semibold text-blue-600"></span>
            </p>
        </div>
        
        <div class="flex items-center gap-2">
            <select x-model="selectedPeriod" 
                    @change="loadData()" 
                    class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                <option value="2025">2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
            </select>
            <button @click="exportPDF()" 
                    class="px-3 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 flex items-center gap-1.5">
                <i data-lucide="file-text" class="w-3.5 h-3.5"></i>
                <span class="hidden sm:inline">PDF</span>
            </button>
            <button @click="exportExcel()" 
                    class="px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center gap-1.5">
                <i data-lucide="download" class="w-3.5 h-3.5"></i>
                <span class="hidden sm:inline">Excel</span>
            </button>
        </div>
    </div>

    <!-- Onglets Modernisés -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700">
        <div class="flex border-b border-gray-200 dark:border-gray-700">
            <button @click="activeTab = 'bilan'" 
                    :class="activeTab === 'bilan' ? 'border-b-2 border-blue-600 text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50'"
                    class="flex-1 px-4 py-3 font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2">
                <i data-lucide="pie-chart" class="w-4 h-4"></i>
                <span>Bilan</span>
            </button>
            <button @click="activeTab = 'resultat'" 
                    :class="activeTab === 'resultat' ? 'border-b-2 border-blue-600 text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50'"
                    class="flex-1 px-4 py-3 font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2">
                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                <span>Compte de Résultat</span>
            </button>
        </div>

        <!-- Contenu -->
        <div class="p-4 sm:p-6">
            
            <!-- ONGLET BILAN -->
            <div x-show="activeTab === 'bilan'" 
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100">
                
                <!-- KPIs Bilan -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/20 rounded-lg p-4 border border-blue-200 dark:border-blue-700">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-xs font-medium text-blue-700 dark:text-blue-300 uppercase tracking-wide">Total Actif</p>
                            <i data-lucide="trending-up" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <p class="text-xl font-bold text-blue-900 dark:text-blue-100" x-text="formatMoney(bilan.totalActif)"></p>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/20 rounded-lg p-4 border border-green-200 dark:border-green-700">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-xs font-medium text-green-700 dark:text-green-300 uppercase tracking-wide">Total Passif</p>
                            <i data-lucide="trending-down" class="w-4 h-4 text-green-600 dark:text-green-400"></i>
                        </div>
                        <p class="text-xl font-bold text-green-900 dark:text-green-100" x-text="formatMoney(bilan.totalPassif)"></p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/20 rounded-lg p-4 border border-purple-200 dark:border-purple-700">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-xs font-medium text-purple-700 dark:text-purple-300 uppercase tracking-wide">Capitaux Propres</p>
                            <i data-lucide="wallet" class="w-4 h-4 text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <p class="text-xl font-bold text-purple-900 dark:text-purple-100" x-text="formatMoney(bilan.capitauxPropres)"></p>
                    </div>
                </div>

                <!-- Bilan en 2 colonnes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    
                    <!-- ACTIF -->
                    <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                            <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                                <i data-lucide="trending-up" class="w-4 h-4 text-blue-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">ACTIF</h3>
                        </div>
                        
                        <!-- Actif Immobilisé -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2 cursor-pointer" @click="toggleSection('actifImmo')">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                                    <i data-lucide="chevron-right" class="w-4 h-4 transition-transform" :class="openSections.actifImmo && 'rotate-90'"></i>
                                    Actif Immobilisé
                                </h4>
                                <span class="text-sm font-bold text-blue-600 dark:text-blue-400" x-text="formatMoney(bilan.actifImmobilise)"></span>
                            </div>
                            <div x-show="openSections.actifImmo" x-collapse class="space-y-1.5 pl-6">
                                <template x-for="item in bilan.actifImmobiliseDetails" :key="item.label">
                                    <div class="flex items-center justify-between py-1.5 text-xs">
                                        <span class="text-gray-600 dark:text-gray-400" x-text="item.label"></span>
                                        <span class="font-semibold text-gray-900 dark:text-white" x-text="formatMoney(item.montant)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Actif Circulant -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2 cursor-pointer" @click="toggleSection('actifCirc')">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                                    <i data-lucide="chevron-right" class="w-4 h-4 transition-transform" :class="openSections.actifCirc && 'rotate-90'"></i>
                                    Actif Circulant
                                </h4>
                                <span class="text-sm font-bold text-blue-600 dark:text-blue-400" x-text="formatMoney(bilan.actifCirculant)"></span>
                            </div>
                            <div x-show="openSections.actifCirc" x-collapse class="space-y-1.5 pl-6">
                                <template x-for="item in bilan.actifCirculantDetails" :key="item.label">
                                    <div class="flex items-center justify-between py-1.5 text-xs">
                                        <span class="text-gray-600 dark:text-gray-400" x-text="item.label"></span>
                                        <span class="font-semibold text-gray-900 dark:text-white" x-text="formatMoney(item.montant)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Total Actif -->
                        <div class="pt-3 border-t-2 border-blue-600">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-gray-900 dark:text-white">TOTAL ACTIF</span>
                                <span class="text-lg font-bold text-blue-600 dark:text-blue-400" x-text="formatMoney(bilan.totalActif)"></span>
                            </div>
                        </div>
                    </div>

                    <!-- PASSIF -->
                    <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                            <div class="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                                <i data-lucide="trending-down" class="w-4 h-4 text-green-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">PASSIF</h3>
                        </div>
                        
                        <!-- Capitaux Propres -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2 cursor-pointer" @click="toggleSection('capitaux')">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                                    <i data-lucide="chevron-right" class="w-4 h-4 transition-transform" :class="openSections.capitaux && 'rotate-90'"></i>
                                    Capitaux Propres
                                </h4>
                                <span class="text-sm font-bold text-green-600 dark:text-green-400" x-text="formatMoney(bilan.capitauxPropres)"></span>
                            </div>
                            <div x-show="openSections.capitaux" x-collapse class="space-y-1.5 pl-6">
                                <template x-for="item in bilan.capitauxPropresDetails" :key="item.label">
                                    <div class="flex items-center justify-between py-1.5 text-xs">
                                        <span class="text-gray-600 dark:text-gray-400" x-text="item.label"></span>
                                        <span class="font-semibold text-gray-900 dark:text-white" x-text="formatMoney(item.montant)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Dettes -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2 cursor-pointer" @click="toggleSection('dettes')">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                                    <i data-lucide="chevron-right" class="w-4 h-4 transition-transform" :class="openSections.dettes && 'rotate-90'"></i>
                                    Dettes
                                </h4>
                                <span class="text-sm font-bold text-green-600 dark:text-green-400" x-text="formatMoney(bilan.dettes)"></span>
                            </div>
                            <div x-show="openSections.dettes" x-collapse class="space-y-1.5 pl-6">
                                <template x-for="item in bilan.dettesDetails" :key="item.label">
                                    <div class="flex items-center justify-between py-1.5 text-xs">
                                        <span class="text-gray-600 dark:text-gray-400" x-text="item.label"></span>
                                        <span class="font-semibold text-gray-900 dark:text-white" x-text="formatMoney(item.montant)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Total Passif -->
                        <div class="pt-3 border-t-2 border-green-600">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-gray-900 dark:text-white">TOTAL PASSIF</span>
                                <span class="text-lg font-bold text-green-600 dark:text-green-400" x-text="formatMoney(bilan.totalPassif)"></span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ONGLET COMPTE DE RÉSULTAT -->
            <div x-show="activeTab === 'resultat'" 
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100">
                
                <!-- KPIs Résultat -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/20 rounded-lg p-3 border border-green-200 dark:border-green-700">
                        <p class="text-xs font-medium text-green-700 dark:text-green-300 mb-1">CA</p>
                        <p class="text-base sm:text-lg font-bold text-green-900 dark:text-green-100" x-text="formatMoney(resultat.ca)"></p>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/30 dark:to-red-800/20 rounded-lg p-3 border border-red-200 dark:border-red-700">
                        <p class="text-xs font-medium text-red-700 dark:text-red-300 mb-1">Charges</p>
                        <p class="text-base sm:text-lg font-bold text-red-900 dark:text-red-100" x-text="formatMoney(resultat.charges)"></p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/20 rounded-lg p-3 border border-blue-200 dark:border-blue-700">
                        <p class="text-xs font-medium text-blue-700 dark:text-blue-300 mb-1">Résultat</p>
                        <p class="text-base sm:text-lg font-bold" :class="resultat.resultatNet >= 0 ? 'text-green-700' : 'text-red-700'" x-text="formatMoney(resultat.resultatNet)"></p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/20 rounded-lg p-3 border border-purple-200 dark:border-purple-700">
                        <p class="text-xs font-medium text-purple-700 dark:text-purple-300 mb-1">Marge</p>
                        <p class="text-base sm:text-lg font-bold text-purple-900 dark:text-purple-100" x-text="((resultat.resultatNet / resultat.ca) * 100).toFixed(1) + '%'"></p>
                    </div>
                </div>

                <!-- Produits et Charges -->
                <div class="space-y-4">
                    
                    <!-- PRODUITS -->
                    <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-200 dark:border-gray-700">
                            <div class="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                                <i data-lucide="arrow-up" class="w-4 h-4 text-green-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">PRODUITS</h3>
                        </div>
                        
                        <div class="space-y-2 mb-3">
                            <template x-for="item in resultat.produits" :key="item.label">
                                <div class="flex items-center justify-between p-2.5 bg-white dark:bg-gray-800 rounded-lg hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300" x-text="item.label"></span>
                                    <span class="text-sm font-bold text-green-600 dark:text-green-400" x-text="formatMoney(item.montant)"></span>
                                </div>
                            </template>
                        </div>

                        <div class="pt-2 border-t-2 border-green-600">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-gray-900 dark:text-white">TOTAL PRODUITS</span>
                                <span class="text-lg font-bold text-green-600 dark:text-green-400" x-text="formatMoney(resultat.totalProduits)"></span>
                            </div>
                        </div>
                    </div>

                    <!-- CHARGES -->
                    <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-200 dark:border-gray-700">
                            <div class="w-8 h-8 bg-red-100 dark:bg-red-900/30 rounded-lg flex items-center justify-center">
                                <i data-lucide="arrow-down" class="w-4 h-4 text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">CHARGES</h3>
                        </div>
                        
                        <div class="space-y-2 mb-3">
                            <template x-for="item in resultat.chargesDetails" :key="item.label">
                                <div class="flex items-center justify-between p-2.5 bg-white dark:bg-gray-800 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300" x-text="item.label"></span>
                                    <span class="text-sm font-bold text-red-600 dark:text-red-400" x-text="formatMoney(item.montant)"></span>
                                </div>
                            </template>
                        </div>

                        <div class="pt-2 border-t-2 border-red-600">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-gray-900 dark:text-white">TOTAL CHARGES</span>
                                <span class="text-lg font-bold text-red-600 dark:text-red-400" x-text="formatMoney(resultat.charges)"></span>
                            </div>
                        </div>
                    </div>

                    <!-- RÉSULTAT NET - Mise en évidence -->
                    <div class="bg-gradient-to-br rounded-xl p-5 border-2 shadow-lg" 
                         :class="resultat.resultatNet >= 0 ? 'from-green-50 via-emerald-50 to-green-100 dark:from-green-900/30 dark:via-emerald-900/20 dark:to-green-800/20 border-green-400 dark:border-green-600' : 'from-red-50 via-rose-50 to-red-100 dark:from-red-900/30 dark:via-rose-900/20 dark:to-red-800/20 border-red-400 dark:border-red-600'">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide mb-1">
                                    RÉSULTAT NET DE L'EXERCICE
                                </p>
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-0.5 rounded-full text-xs font-bold" 
                                          :class="resultat.resultatNet >= 0 ? 'bg-green-600 text-white' : 'bg-red-600 text-white'" 
                                          x-text="resultat.resultatNet >= 0 ? '✓ Bénéfice' : '✗ Perte'">
                                    </span>
                                    <span class="text-xs text-gray-500">Exercice <span x-text="selectedPeriod"></span></span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold" 
                                   :class="resultat.resultatNet >= 0 ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'" 
                                   x-text="formatMoney(resultat.resultatNet)">
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function rapportsData() {
    return {
        activeTab: 'bilan',
        selectedPeriod: '2025',
        
        openSections: {
            actifImmo: true,
            actifCirc: true,
            capitaux: true,
            dettes: true
        },
        
        bilan: {
            totalActif: 45000000,
            totalPassif: 45000000,
            capitauxPropres: 25000000,
            actifImmobilise: 20000000,
            actifCirculant: 25000000,
            dettes: 20000000,
            
            actifImmobiliseDetails: [
                { label: 'Immobilisations corporelles', montant: 15000000 },
                { label: 'Immobilisations incorporelles', montant: 3000000 },
                { label: 'Immobilisations financières', montant: 2000000 }
            ],
            
            actifCirculantDetails: [
                { label: 'Stocks', montant: 10000000 },
                { label: 'Créances clients', montant: 8000000 },
                { label: 'Banque', montant: 6000000 },
                { label: 'Caisse', montant: 1000000 }
            ],
            
            capitauxPropresDetails: [
                { label: 'Capital social', montant: 10000000 },
                { label: 'Réserves', montant: 8000000 },
                { label: 'Résultat de l\'exercice', montant: 7000000 }
            ],
            
            dettesDetails: [
                { label: 'Emprunts bancaires', montant: 12000000 },
                { label: 'Dettes fournisseurs', montant: 6000000 },
                { label: 'Dettes fiscales et sociales', montant: 2000000 }
            ]
        },
        
        resultat: {
            ca: 50000000,
            charges: 38000000,
            resultatNet: 12000000,
            totalProduits: 52000000,
            
            produits: [
                { label: 'Ventes de marchandises', montant: 45000000 },
                { label: 'Prestations de services', montant: 5000000 },
                { label: 'Produits financiers', montant: 2000000 }
            ],
            
            chargesDetails: [
                { label: 'Achats de marchandises', montant: 20000000 },
                { label: 'Charges de personnel', montant: 10000000 },
                { label: 'Charges externes', montant: 5000000 },
                { label: 'Impôts et taxes', montant: 2000000 },
                { label: 'Charges financières', montant: 1000000 }
            ]
        },
        
        init() {
            lucide.createIcons();
        },
        
        toggleSection(section) {
            this.openSections[section] = !this.openSections[section];
            this.$nextTick(() => lucide.createIcons());
        },
        
        loadData() {
            // Animation de chargement
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
            toast.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Chargement de l\'exercice ' + this.selectedPeriod;
            document.body.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.remove();
            }, 1500);
        },
        
        exportPDF() {
            this.showToast('📄 Export PDF en cours...', 'blue');
        },
        
        exportExcel() {
            this.showToast('📊 Export Excel en cours...', 'green');
        },
        
        showToast(message, color) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 bg-${color}-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-bounce`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'none';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        },
        
        formatMoney(amount) {
            if (!amount && amount !== 0) return '0 FCFA';
            return new Intl.NumberFormat('fr-FR', { 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0 
            }).format(amount) + ' FCFA';
        }
    }
}
</script>
{% endblock %}