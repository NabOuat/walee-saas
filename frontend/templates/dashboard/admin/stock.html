{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block title %}Stock - Walee{% endblock %}

{% block dashboard_content %}
<div x-data="stockData()">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold font-poppins text-walee-dark dark:text-white mb-2">
                Gestion du Stock
            </h1>
            <p class="text-gray-600 dark:text-gray-400">Suivez votre inventaire en temps r√©el</p>
        </div>
        <button @click="showAddProductModal = true" 
                class="flex items-center space-x-2 px-6 py-3 bg-walee-blue text-white font-semibold rounded-xl hover:bg-blue-700 transform hover:scale-105 transition">
            <i data-lucide="plus" class="w-5 h-5"></i>
            <span>Ajouter un produit</span>
        </button>
    </div>
    
    <!-- Filtre Entreprise -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-6 shadow-sm">
        <div class="flex items-center space-x-4">
            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Entreprise:</label>
            <select x-model="selectedEntreprise" 
                    @change="loadStock()"
                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-walee-blue outline-none">
                <option value="">üìä Toutes les entreprises</option>
                <option value="1">üè¢ ACME Corporation</option>
                <option value="2">üíª Tech Boutique</option>
                <option value="3">üçΩÔ∏è Restaurant Saveurs</option>
            </select>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- Produits Total -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm hover:shadow-md transition">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-xl flex items-center justify-center">
                    <i data-lucide="package" class="w-6 h-6 text-walee-blue"></i>
                </div>
                <span class="text-green-500 text-sm font-medium">+12</span>
            </div>
            <h3 class="text-gray-500 dark:text-gray-400 text-sm mb-1">Produits Total</h3>
            <p class="text-3xl font-bold font-poppins text-walee-dark dark:text-white" x-text="stats.produitsTotal"></p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">R√©f√©rences</p>
        </div>
        
        <!-- Valeur Stock -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm hover:shadow-md transition">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-xl flex items-center justify-center">
                    <i data-lucide="dollar-sign" class="w-6 h-6 text-walee-green"></i>
                </div>
                <span class="text-green-500 text-sm font-medium">+8.5%</span>
            </div>
            <h3 class="text-gray-500 dark:text-gray-400 text-sm mb-1">Valeur Stock</h3>
            <p class="text-3xl font-bold font-poppins text-walee-dark dark:text-white" x-text="formatMoney(stats.valeurStock)"></p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">FCFA</p>
        </div>
        
        <!-- Rupture de Stock -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm hover:shadow-md transition">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-xl flex items-center justify-center">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                </div>
                <span class="text-red-500 text-sm font-medium">-2</span>
            </div>
            <h3 class="text-gray-500 dark:text-gray-400 text-sm mb-1">Rupture de Stock</h3>
            <p class="text-3xl font-bold font-poppins text-red-600 dark:text-red-400" x-text="stats.ruptureStock"></p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Produits</p>
        </div>
        
        <!-- Stock Faible -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm hover:shadow-md transition">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-xl flex items-center justify-center">
                    <i data-lucide="alert-circle" class="w-6 h-6 text-orange-600 dark:text-orange-400"></i>
                </div>
                <span class="text-orange-500 text-sm font-medium">Alerte</span>
            </div>
            <h3 class="text-gray-500 dark:text-gray-400 text-sm mb-1">Stock Faible</h3>
            <p class="text-3xl font-bold font-poppins text-orange-600 dark:text-orange-400" x-text="stats.stockFaible"></p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">< 10 unit√©s</p>
        </div>
        
    </div>
    
    <!-- Alertes -->
    <div x-show="stats.ruptureStock > 0 || stats.stockFaible > 0" class="mb-6">
        <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-xl p-4">
            <div class="flex items-start space-x-3">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600 dark:text-orange-400 flex-shrink-0"></i>
                <div>
                    <h4 class="font-bold text-orange-900 dark:text-orange-300 mb-1">Alertes Stock</h4>
                    <p class="text-sm text-orange-800 dark:text-orange-400">
                        <span x-text="stats.ruptureStock"></span> produits en rupture de stock et 
                        <span x-text="stats.stockFaible"></span> produits avec stock faible
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtres -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-6 shadow-sm">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input type="text" 
                           x-model="searchQuery"
                           placeholder="Rechercher un produit..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-walee-blue focus:border-transparent outline-none">
                </div>
            </div>
            
            <div class="flex space-x-3">
                <select x-model="selectedCategorie"
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-walee-blue outline-none">
                    <option value="">Toutes les cat√©gories</option>
                    <option>√âlectronique</option>
                    <option>V√™tements</option>
                    <option>Alimentation</option>
                    <option>Autres</option>
                </select>
                
                <select x-model="selectedStockStatus"
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-walee-blue outline-none">
                    <option value="">Tous les stocks</option>
                    <option value="ok">Stock OK</option>
                    <option value="faible">Stock faible</option>
                    <option value="rupture">Rupture</option>
                </select>
                
                <button class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    <i data-lucide="download" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Stock Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Produit</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase" x-show="!selectedEntreprise">Entreprise</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Cat√©gorie</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Prix</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Quantit√©</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Statut</th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                
                <template x-for="produit in filteredProduits" :key="produit.id">
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                    <i data-lucide="box" class="w-6 h-6 text-gray-400"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900 dark:text-white" x-text="produit.nom"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400" x-text="produit.reference"></p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4" x-show="!selectedEntreprise">
                            <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-blue-50 dark:bg-blue-900 text-blue-700 dark:text-blue-300">
                                <i data-lucide="building-2" class="w-3 h-3 mr-1"></i>
                                <span x-text="produit.entreprise"></span>
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-sm text-gray-700 dark:text-gray-300" x-text="produit.categorie"></span>
                        </td>
                        <td class="px-6 py-4">
                            <p class="font-semibold text-gray-900 dark:text-white" x-text="formatMoney(produit.prix)"></p>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                <p class="font-semibold" :class="getQuantityClass(produit.quantite, produit.seuilMin)" x-text="produit.quantite"></p>
                                <span class="text-xs text-gray-500 dark:text-gray-400">/ <span x-text="produit.seuilMin"></span></span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-2">
                                <div class="h-1.5 rounded-full transition-all"
                                     :class="getStockBarClass(produit.quantite, produit.seuilMin)"
                                     :style="`width: ${Math.min((produit.quantite / produit.seuilMin) * 100, 100)}%`"></div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-3 py-1 rounded-full text-xs font-medium"
                                  :class="getStockStatusClass(produit.quantite, produit.seuilMin)">
                                <span x-text="getStockStatusText(produit.quantite, produit.seuilMin)"></span>
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex space-x-2">
                                <button @click="adjustStock(produit, 'add')" 
                                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition"
                                        title="Ajouter stock">
                                    <i data-lucide="plus" class="w-4 h-4 text-green-600 dark:text-green-400"></i>
                                </button>
                                <button @click="adjustStock(produit, 'remove')" 
                                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition"
                                        title="Retirer stock">
                                    <i data-lucide="minus" class="w-4 h-4 text-orange-600 dark:text-orange-400"></i>
                                </button>
                                <button @click="editProduit(produit)" 
                                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition"
                                        title="Modifier">
                                    <i data-lucide="edit" class="w-4 h-4 text-gray-600 dark:text-gray-400"></i>
                                </button>
                                <button @click="deleteProduit(produit)" 
                                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition"
                                        title="Supprimer">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-red-600 dark:text-red-400"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
                
            </tbody>
        </table>
    </div>
    
    <!-- Modal Ajout Produit -->
    <div x-show="showAddProductModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
         @click.self="showAddProductModal = false"
         style="display: none;">
        
        <div x-show="showAddProductModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-90"
             x-transition:enter-end="opacity-100 scale-100"
             class="bg-white dark:bg-gray-800 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between z-10">
                <h2 class="text-2xl font-bold font-poppins text-walee-dark dark:text-white">Ajouter un Produit</h2>
                <button @click="showAddProductModal = false" 
                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <form @submit.prevent="handleAddProduct()" class="p-6 space-y-6">
                
                <!-- Entreprise -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Entreprise *
                    </label>
                    <select x-model="productForm.entrepriseId" 
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                            required>
                        <option value="">S√©lectionnez une entreprise</option>
                        <option value="1">ACME Corporation</option>
                        <option value="2">Tech Boutique</option>
                        <option value="3">Restaurant Saveurs</option>
                    </select>
                </div>
                
                <!-- Nom & R√©f√©rence -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Nom du produit *
                        </label>
                        <input type="text" 
                               x-model="productForm.nom"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                               placeholder="Ex: Laptop HP Pavilion"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            R√©f√©rence
                        </label>
                        <input type="text" 
                               x-model="productForm.reference"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                               placeholder="PRD-XXX">
                    </div>
                </div>
                
                <!-- Cat√©gorie & Code-barres -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Cat√©gorie *
                        </label>
                        <select x-model="productForm.categorie" 
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                                required>
                            <option value="">S√©lectionnez</option>
                            <option>√âlectronique</option>
                            <option>V√™tements</option>
                            <option>Alimentation</option>
                            <option>Autres</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Code-barres
                        </label>
                        <input type="text" 
                               x-model="productForm.codeBarres"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                               placeholder="123456789">
                    </div>
                </div>
                
                <!-- Prix -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Prix d'achat (FCFA)
                        </label>
                        <input type="number" 
                               x-model="productForm.prixAchat"
                               min="0"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                               placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Prix de vente (FCFA) *
                        </label>
                        <input type="number" 
                               x-model="productForm.prix"
                               min="0"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                               placeholder="0"
                               required>
                    </div>
                </div>
                
                <!-- Marge calcul√©e -->
                <div x-show="productForm.prixAchat > 0 && productForm.prix > 0" 
                     class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Marge b√©n√©ficiaire:</span>
                        <span class="font-bold text-blue-600 dark:text-blue-400" 
                              x-text="calculateMargin() + '%'"></span>
                    </div>
                </div>
                
                <!-- Stock -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Quantit√© initiale *
                        </label>
                        <input type="number" 
                               x-model="productForm.quantite"
                               min="0"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                               placeholder="0"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Seuil minimum *
                        </label>
                        <input type="number" 
                               x-model="productForm.seuilMin"
                               min="0"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                               placeholder="10"
                               required>
                    </div>
                </div>
                
                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Description
                    </label>
                    <textarea x-model="productForm.description"
                              rows="3"
                              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none"
                              placeholder="Description du produit..."></textarea>
                </div>
                
                <!-- Actions -->
                <div class="flex space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" 
                            @click="showAddProductModal = false"
                            class="flex-1 px-6 py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="flex-1 px-6 py-3 bg-walee-blue text-white font-semibold rounded-xl hover:bg-blue-700 transition">
                        Ajouter le produit
                    </button>
                </div>
                
            </form>
            
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
function stockData() {
    return {
        showAddProductModal: false,
        selectedEntreprise: '',
        searchQuery: '',
        selectedCategorie: '',
        selectedStockStatus: '',
        
        stats: {
            produitsTotal: 1234,
            valeurStock: 45600000,
            ruptureStock: 3,
            stockFaible: 12
        },
        
        produits: [
            { id: 1, nom: 'Laptop HP Pavilion', reference: 'PRD-001', entreprise: 'ACME Corporation', entrepriseId: 1, categorie: '√âlectronique', prix: 450000, quantite: 15, seuilMin: 10 },
            { id: 2, nom: 'iPhone 13 Pro', reference: 'PRD-002', entreprise: 'Tech Boutique', entrepriseId: 2, categorie: '√âlectronique', prix: 650000, quantite: 5, seuilMin: 10 },
            { id: 3, nom: 'T-shirt Nike', reference: 'PRD-003', entreprise: 'ACME Corporation', entrepriseId: 1, categorie: 'V√™tements', prix: 15000, quantite: 0, seuilMin: 20 },
            { id: 4, nom: 'Riz 50kg', reference: 'PRD-004', entreprise: 'Restaurant Saveurs', entrepriseId: 3, categorie: 'Alimentation', prix: 25000, quantite: 45, seuilMin: 30 },
            { id: 5, nom: 'Samsung Galaxy S23', reference: 'PRD-005', entreprise: 'Tech Boutique', entrepriseId: 2, categorie: '√âlectronique', prix: 550000, quantite: 8, seuilMin: 10 },
        ],
        
        // Modal Ajout Produit
        productForm: {
            entrepriseId: '',
            nom: '',
            reference: '',
            categorie: '',
            codeBarres: '',
            prixAchat: 0,
            prix: 0,
            quantite: 0,
            seuilMin: 10,
            description: ''
        },
        
        get filteredProduits() {
            return this.produits.filter(produit => {
                const matchSearch = !this.searchQuery || 
                    produit.nom.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    produit.reference.toLowerCase().includes(this.searchQuery.toLowerCase());
                
                const matchEntreprise = !this.selectedEntreprise || 
                    produit.entrepriseId == this.selectedEntreprise;
                
                const matchCategorie = !this.selectedCategorie || 
                    produit.categorie === this.selectedCategorie;
                
                const matchStockStatus = !this.selectedStockStatus || 
                    (this.selectedStockStatus === 'ok' && produit.quantite >= produit.seuilMin) ||
                    (this.selectedStockStatus === 'faible' && produit.quantite > 0 && produit.quantite < produit.seuilMin) ||
                    (this.selectedStockStatus === 'rupture' && produit.quantite === 0);
                
                return matchSearch && matchEntreprise && matchCategorie && matchStockStatus;
            });
        },
        
        loadStock() {
            console.log('Chargement stock pour entreprise:', this.selectedEntreprise);
        },
        
        formatMoney(amount) {
            return new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';
        },
        
        getQuantityClass(quantite, seuilMin) {
            if (quantite === 0) return 'text-red-600 dark:text-red-400';
            if (quantite < seuilMin) return 'text-orange-600 dark:text-orange-400';
            return 'text-green-600 dark:text-green-400';
        },
        
        getStockBarClass(quantite, seuilMin) {
            if (quantite === 0) return 'bg-red-600';
            if (quantite < seuilMin) return 'bg-orange-600';
            return 'bg-green-600';
        },
        
        getStockStatusClass(quantite, seuilMin) {
            if (quantite === 0) return 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
            if (quantite < seuilMin) return 'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300';
            return 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300';
        },
        
        getStockStatusText(quantite, seuilMin) {
            if (quantite === 0) return 'Rupture';
            if (quantite < seuilMin) return 'Stock faible';
            return 'Stock OK';
        },
        
        adjustStock(produit, action) {
            const quantite = prompt(`${action === 'add' ? '‚ûï Ajouter' : '‚ûñ Retirer'} du stock\n\nProduit: ${produit.nom}\nStock actuel: ${produit.quantite}\n\nQuantit√©:`, '1');
            
            if (quantite && !isNaN(quantite)) {
                const qty = parseInt(quantite);
                if (action === 'add') {
                    produit.quantite += qty;
                    alert(`‚úÖ ${qty} unit√©s ajout√©es\nNouveau stock: ${produit.quantite}`);
                } else {
                    if (produit.quantite >= qty) {
                        produit.quantite -= qty;
                        alert(`‚úÖ ${qty} unit√©s retir√©es\nNouveau stock: ${produit.quantite}`);
                    } else {
                        alert(`‚ùå Stock insuffisant\nStock actuel: ${produit.quantite}`);
                    }
                }
            }
        },
        
        editProduit(produit) {
            alert(`‚úèÔ∏è Modification de "${produit.nom}"\n\nFonctionnalit√© √† venir`);
        },
        
        deleteProduit(produit) {
            if (confirm(`‚ö†Ô∏è Supprimer "${produit.nom}" ?\n\nCette action est irr√©versible.`)) {
                const index = this.produits.findIndex(p => p.id === produit.id);
                if (index > -1) {
                    this.produits.splice(index, 1);
                    alert(`‚úÖ Produit supprim√©.`);
                }
            }
        },
        
        // Fonctions Modal Produit
        calculateMargin() {
            if (this.productForm.prixAchat > 0 && this.productForm.prix > 0) {
                const margin = ((this.productForm.prix - this.productForm.prixAchat) / this.productForm.prixAchat) * 100;
                return margin.toFixed(1);
            }
            return 0;
        },
        
        handleAddProduct() {
            // G√©n√©rer r√©f√©rence si vide
            if (!this.productForm.reference) {
                this.productForm.reference = `PRD-${String(this.produits.length + 1).padStart(3, '0')}`;
            }
            
            // Cr√©er le nouveau produit
            const newProduct = {
                id: this.produits.length + 1,
                nom: this.productForm.nom,
                reference: this.productForm.reference,
                entreprise: this.getEntrepriseName(this.productForm.entrepriseId),
                entrepriseId: parseInt(this.productForm.entrepriseId),
                categorie: this.productForm.categorie,
                prix: parseInt(this.productForm.prix),
                quantite: parseInt(this.productForm.quantite),
                seuilMin: parseInt(this.productForm.seuilMin)
            };
            
            this.produits.push(newProduct);
            
            alert(`‚úÖ Produit "${newProduct.nom}" ajout√© avec succ√®s !\n\nR√©f√©rence: ${newProduct.reference}\nStock initial: ${newProduct.quantite} unit√©s`);
            
            // R√©initialiser le formulaire
            this.productForm = {
                entrepriseId: '',
                nom: '',
                reference: '',
                categorie: '',
                codeBarres: '',
                prixAchat: 0,
                prix: 0,
                quantite: 0,
                seuilMin: 10,
                description: ''
            };
            this.showAddProductModal = false;
        },
        
        getEntrepriseName(id) {
            const entreprises = {
                '1': 'ACME Corporation',
                '2': 'Tech Boutique',
                '3': 'Restaurant Saveurs'
            };
            return entreprises[id] || 'Non d√©finie';
        }
    }
}
</script>
{% endblock %}
