{% extends "base.html" %}
{% load static %}

{% block title %}Mot de passe oublié - Walee{% endblock %}

{% block extra_head %}
<script src="{% static 'js/auth-api.js' %}"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-walee-green via-emerald-600 to-teal-700 py-12">
    
    <!-- Animated Background Elements -->
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute top-20 right-10 w-72 h-72 bg-blue-400 opacity-20 rounded-full blur-3xl animate-float"></div>
        <div class="absolute bottom-20 left-10 w-96 h-96 bg-walee-blue opacity-20 rounded-full blur-3xl animate-float" style="animation-delay: 1s;"></div>
    </div>
    
    <!-- Forgot Password Container -->
    <div class="relative z-10 w-full max-w-2xl mx-4 animate-fade-in">
        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
            
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center space-x-3 mb-4">
                    <img src="{% static 'images/logo.png' %}" alt="Walee Logo" class="w-12 h-12">
                    <h2 class="text-4xl font-bold font-poppins text-walee-dark">Walee</h2>
                </div>
                <h3 class="text-2xl font-bold font-poppins text-walee-dark mb-2">Réinitialiser le mot de passe</h3>
                <p class="text-gray-500">Récupérez l'accès à votre compte</p>
            </div>
            
            <!-- Progress Steps -->
            <div class="mb-8" x-data="forgotPasswordForm()">
                <div class="flex items-center justify-center space-x-4">
                    <div class="flex items-center">
                        <div :class="step >= 1 ? 'bg-walee-green text-white' : 'bg-gray-200 text-gray-500'" 
                             class="w-10 h-10 rounded-full flex items-center justify-center font-bold">
                            1
                        </div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 1 ? 'text-walee-green' : 'text-gray-500'">
                            Identifiant
                        </span>
                    </div>
                    <div class="w-16 h-1" :class="step >= 2 ? 'bg-walee-green' : 'bg-gray-200'"></div>
                    <div class="flex items-center">
                        <div :class="step >= 2 ? 'bg-walee-green text-white' : 'bg-gray-200 text-gray-500'" 
                             class="w-10 h-10 rounded-full flex items-center justify-center font-bold">
                            2
                        </div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 2 ? 'text-walee-green' : 'text-gray-500'">
                            Vérification
                        </span>
                    </div>
                    <div class="w-16 h-1" :class="step >= 3 ? 'bg-walee-green' : 'bg-gray-200'"></div>
                    <div class="flex items-center">
                        <div :class="step >= 3 ? 'bg-walee-green text-white' : 'bg-gray-200 text-gray-500'" 
                             class="w-10 h-10 rounded-full flex items-center justify-center font-bold">
                            3
                        </div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 3 ? 'text-walee-green' : 'text-gray-500'">
                            Terminé
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Forgot Password Form -->
            <form class="space-y-6" x-data="forgotPasswordForm()" @submit.prevent="handleSubmit">
                
                <!-- ÉTAPE 1: Identifiant -->
                <div x-show="step === 1" x-transition>
                    
                    <!-- Method Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Méthode de récupération
                        </label>
                        <div class="flex items-center space-x-4 bg-gray-100 rounded-xl p-1">
                            <button 
                                type="button"
                                @click="recoveryMethod = 'email'"
                                :class="recoveryMethod === 'email' ? 'bg-white shadow-sm' : 'bg-transparent'"
                                class="flex-1 py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2"
                            >
                                <i data-lucide="mail" class="w-4 h-4" :class="recoveryMethod === 'email' ? 'text-walee-green' : 'text-gray-500'"></i>
                                <span class="text-sm font-medium">Email</span>
                            </button>
                            <button 
                                type="button"
                                @click="recoveryMethod = 'phone'"
                                :class="recoveryMethod === 'phone' ? 'bg-white shadow-sm' : 'bg-transparent'"
                                class="flex-1 py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2"
                            >
                                <i data-lucide="smartphone" class="w-4 h-4" :class="recoveryMethod === 'phone' ? 'text-walee-green' : 'text-gray-500'"></i>
                                <span class="text-sm font-medium">Téléphone</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Email -->
                    <div x-show="recoveryMethod === 'email'" x-transition>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            Adresse email *
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i data-lucide="mail" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <input 
                                type="email" 
                                id="email" 
                                x-model="email"
                                class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-walee-green focus:border-transparent transition duration-200 outline-none"
                                placeholder="vous@exemple.com"
                                :required="recoveryMethod === 'email'"
                            >
                        </div>
                    </div>
                    
                    <!-- Téléphone -->
                    <div x-show="recoveryMethod === 'phone'" x-transition>
                        <label for="telephone" class="block text-sm font-medium text-gray-700 mb-2">
                            Numéro de téléphone *
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i data-lucide="smartphone" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <input 
                                type="tel" 
                                id="telephone" 
                                x-model="telephone"
                                class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-walee-green focus:border-transparent transition duration-200 outline-none"
                                placeholder="+225 07 XX XX XX XX"
                                :required="recoveryMethod === 'phone'"
                            >
                        </div>
                        <p class="mt-2 text-xs text-gray-500">
                            <i data-lucide="info" class="w-3 h-3 inline"></i>
                            Format: +225 suivi de votre numéro
                        </p>
                    </div>
                    
                    <!-- Submit Button -->
                    <button 
                        type="button"
                        @click="envoyerCodeReset()"
                        :disabled="loading"
                        class="w-full bg-walee-green text-white font-semibold py-3 px-6 rounded-xl hover:bg-emerald-600 hover:shadow-lg transform hover:scale-105 transition duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span x-show="!loading">Recevoir le code</span>
                        <span x-show="loading">Envoi en cours...</span>
                        <i data-lucide="send" class="w-5 h-5" x-show="!loading"></i>
                    </button>
                </div>
                
                <!-- ÉTAPE 2: Vérification OTP + Nouveau mot de passe -->
                <div x-show="step === 2" x-transition>
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-walee-green/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="shield-check" class="w-8 h-8 text-walee-green"></i>
                        </div>
                        <h4 class="text-xl font-bold text-walee-dark mb-2">Vérifiez votre code</h4>
                        <p class="text-gray-600">
                            Un code à 6 chiffres a été envoyé à<br>
                            <span class="font-semibold" x-text="recoveryMethod === 'email' ? email : telephone"></span>
                        </p>
                    </div>
                    
                    <!-- OTP Input -->
                    <div class="mb-6">
                        <label for="code_otp" class="block text-sm font-medium text-gray-700 mb-2 text-center">
                            Code de vérification
                        </label>
                        <input 
                            type="text" 
                            id="code_otp" 
                            x-model="code"
                            maxlength="6"
                            class="w-full text-center text-3xl font-bold tracking-widest px-4 py-4 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-walee-green focus:border-walee-green transition duration-200 outline-none"
                            placeholder="000000"
                            required
                            @input="code = code.replace(/[^0-9]/g, '')"
                        >
                        <p class="mt-2 text-xs text-gray-500 text-center">
                            Le code expire dans <span class="font-semibold text-walee-green" x-text="formatCountdown(countdown)"></span>
                        </p>
                    </div>
                    
                    <!-- Nouveau mot de passe -->
                    <div class="mb-6">
                        <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">
                            Nouveau mot de passe *
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i data-lucide="lock" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <input 
                                :type="showPassword ? 'text' : 'password'" 
                                id="new_password" 
                                x-model="newPassword"
                                class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-walee-green focus:border-transparent transition duration-200 outline-none"
                                placeholder="Min. 8 caractères"
                                required
                                minlength="8"
                            >
                            <button 
                                type="button"
                                @click="showPassword = !showPassword"
                                class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600"
                            >
                                <i :data-lucide="showPassword ? 'eye-off' : 'eye'" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">
                            <i data-lucide="info" class="w-3 h-3 inline"></i>
                            Minimum 8 caractères
                        </p>
                    </div>
                    
                    <!-- Confirmer mot de passe -->
                    <div class="mb-6">
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-2">
                            Confirmer le mot de passe *
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i data-lucide="lock" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <input 
                                :type="showConfirmPassword ? 'text' : 'password'" 
                                id="confirm_password" 
                                x-model="confirmPassword"
                                class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-walee-green focus:border-transparent transition duration-200 outline-none"
                                placeholder="Confirmer le mot de passe"
                                required
                                minlength="8"
                            >
                            <button 
                                type="button"
                                @click="showConfirmPassword = !showConfirmPassword"
                                class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600"
                            >
                                <i :data-lucide="showConfirmPassword ? 'eye-off' : 'eye'" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Reset Button -->
                    <button 
                        type="button"
                        @click="resetPassword()"
                        :disabled="loading || code.length !== 6 || !newPassword || newPassword !== confirmPassword"
                        class="w-full bg-walee-green text-white font-semibold py-3 px-6 rounded-xl hover:bg-emerald-600 hover:shadow-lg transform hover:scale-105 transition duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed mb-4"
                    >
                        <span x-show="!loading">Réinitialiser le mot de passe</span>
                        <span x-show="loading">Réinitialisation...</span>
                        <i data-lucide="check-circle" class="w-5 h-5" x-show="!loading"></i>
                    </button>
                    
                    <!-- Resend Code -->
                    <div class="text-center">
                        <button 
                            type="button"
                            @click="renvoyerCode()"
                            :disabled="loading || countdown > 0"
                            class="text-sm text-walee-green hover:text-emerald-600 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i>
                            Renvoyer le code
                        </button>
                    </div>
                    
                    <!-- Back Button -->
                    <div class="mt-4 text-center">
                        <button 
                            type="button"
                            @click="step = 1; code = ''; newPassword = ''; confirmPassword = ''"
                            class="text-sm text-gray-600 hover:text-gray-800"
                        >
                            <i data-lucide="arrow-left" class="w-4 h-4 inline"></i>
                            Modifier mon identifiant
                        </button>
                    </div>
                </div>
                
                <!-- ÉTAPE 3: Succès -->
                <div x-show="step === 3" x-transition>
                    <div class="text-center py-8">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
                            <i data-lucide="check-circle" class="w-12 h-12 text-green-600"></i>
                        </div>
                        <h4 class="text-2xl font-bold text-walee-dark mb-3">Mot de passe réinitialisé !</h4>
                        <p class="text-gray-600 mb-6">
                            Votre mot de passe a été changé avec succès 🎉
                        </p>
                        <p class="text-sm text-gray-500">
                            Redirection vers la page de connexion...
                        </p>
                    </div>
                </div>
                
            </form>
            
            <!-- Back to Login Link -->
            <div class="mt-8 text-center">
                <p class="text-gray-600">
                    Vous vous souvenez de votre mot de passe ? 
                    <a href="{% url 'login' %}" class="text-walee-green hover:text-emerald-600 font-semibold transition">
                        Se connecter
                    </a>
                </p>
            </div>
            
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
function forgotPasswordForm() {
    return {
        step: 1,
        recoveryMethod: 'email',
        email: '',
        telephone: '',
        code: '',
        newPassword: '',
        confirmPassword: '',
        showPassword: false,
        showConfirmPassword: false,
        loading: false,
        countdown: 0,
        countdownInterval: null,
        
        async envoyerCodeReset() {
            // Validation
            if (this.recoveryMethod === 'email' && !this.email) {
                afficherToast('Veuillez entrer votre email', 'error');
                return;
            }
            
            if (this.recoveryMethod === 'phone' && !this.telephone) {
                afficherToast('Veuillez entrer votre téléphone', 'error');
                return;
            }
            
            this.loading = true;
            
            try {
                const response = await fetch('http://localhost:8000/api/auth/forgot-password/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: this.recoveryMethod === 'email' ? this.email : null,
                        telephone: this.recoveryMethod === 'phone' ? this.telephone : null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.step = 2;
                    this.startCountdown();
                    
                    // En mode DEV, afficher le code
                    if (result.data.code_otp) {
                        afficherToast(`Code OTP: ${result.data.code_otp}`, 'info');
                    } else {
                        afficherToast('Code de réinitialisation envoyé', 'success');
                    }
                } else {
                    const errorMsg = result.errors ? Object.values(result.errors).flat().join(', ') : result.message;
                    afficherToast(errorMsg, 'error');
                }
            } catch (error) {
                afficherToast('Erreur de connexion au serveur', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        async resetPassword() {
            // Validation
            if (this.code.length !== 6) {
                afficherToast('Le code doit contenir 6 chiffres', 'error');
                return;
            }
            
            if (!this.newPassword || this.newPassword.length < 8) {
                afficherToast('Le mot de passe doit contenir au moins 8 caractères', 'error');
                return;
            }
            
            if (this.newPassword !== this.confirmPassword) {
                afficherToast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            this.loading = true;
            
            try {
                const response = await fetch('http://localhost:8000/api/auth/reset-password/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: this.recoveryMethod === 'email' ? this.email : null,
                        telephone: this.recoveryMethod === 'phone' ? this.telephone : null,
                        code: this.code,
                        new_password: this.newPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.step = 3;
                    this.stopCountdown();
                    afficherToast('Mot de passe réinitialisé avec succès !', 'success');
                    
                    // Redirection après 2 secondes
                    setTimeout(() => {
                        window.location.href = '/login/';
                    }, 2000);
                } else {
                    const errorMsg = result.errors ? Object.values(result.errors).flat().join(', ') : result.message;
                    afficherToast(errorMsg, 'error');
                }
            } catch (error) {
                afficherToast('Erreur de connexion au serveur', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        async renvoyerCode() {
            this.loading = true;
            
            try {
                const response = await fetch('http://localhost:8000/api/auth/resend-otp/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: this.recoveryMethod === 'email' ? this.email : null,
                        telephone: this.recoveryMethod === 'phone' ? this.telephone : null,
                        motif: 'reset_password'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.code = '';
                    this.startCountdown();
                    
                    // En mode DEV, afficher le code
                    if (result.data.code_otp) {
                        afficherToast(`Nouveau code: ${result.data.code_otp}`, 'info');
                    } else {
                        afficherToast('Nouveau code envoyé', 'success');
                    }
                } else {
                    afficherToast(result.message, 'error');
                }
            } catch (error) {
                afficherToast('Erreur de connexion au serveur', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        startCountdown() {
            this.countdown = 600; // 10 minutes
            this.countdownInterval = setInterval(() => {
                this.countdown--;
                if (this.countdown <= 0) {
                    this.stopCountdown();
                }
            }, 1000);
        },
        
        stopCountdown() {
            if (this.countdownInterval) {
                clearInterval(this.countdownInterval);
                this.countdownInterval = null;
            }
        },
        
        formatCountdown(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        },
        
        handleSubmit() {
            // Prevent default form submission
        }
    }
}

// Réinitialiser les icônes
document.addEventListener('alpine:init', () => {
    setTimeout(() => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 100);
});

// Réinitialiser les icônes lors des changements
document.addEventListener('click', () => {
    setTimeout(() => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 50);
});
</script>
{% endblock %}
