{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block title %}Comptabilité - Walee{% endblock %}

{% block dashboard_content %}
<div x-data="comptableData()">
    
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold font-poppins text-walee-dark dark:text-white mb-2">
            Comptabilité & Finances
        </h1>
        <p class="text-gray-600 dark:text-gray-400">Gérez les finances et la comptabilité</p>
    </div>
    
    <!-- Période -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-6 shadow-sm">
        <div class="flex items-center space-x-4">
            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Période:</label>
            <select x-model="selectedPeriod" 
                    @change="loadData()"
                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-walee-blue outline-none">
                <option value="month">Ce mois</option>
                <option value="quarter">Ce trimestre</option>
                <option value="year">Cette année</option>
            </select>
        </div>
    </div>
    
    <!-- Stats Financières -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 text-white shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                </div>
                <span class="text-sm bg-white/20 px-3 py-1 rounded-full">+15%</span>
            </div>
            <h3 class="text-sm opacity-90 mb-1">Chiffre d'Affaires</h3>
            <p class="text-3xl font-bold font-poppins" x-text="formatMoney(stats.ca)"></p>
        </div>
        
        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="arrow-down" class="w-6 h-6"></i>
                </div>
                <span class="text-sm bg-white/20 px-3 py-1 rounded-full">+8%</span>
            </div>
            <h3 class="text-sm opacity-90 mb-1">Dépenses</h3>
            <p class="text-3xl font-bold font-poppins" x-text="formatMoney(stats.depenses)"></p>
        </div>
        
        <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl p-6 text-white shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="wallet" class="w-6 h-6"></i>
                </div>
                <span class="text-sm bg-white/20 px-3 py-1 rounded-full">+23%</span>
            </div>
            <h3 class="text-sm opacity-90 mb-1">Bénéfice Net</h3>
            <p class="text-3xl font-bold font-poppins" x-text="formatMoney(stats.benefice)"></p>
        </div>
        
        <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-xl p-6 text-white shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="file-text" class="w-6 h-6"></i>
                </div>
                <span class="text-sm bg-white/20 px-3 py-1 rounded-full" x-text="stats.facturesEnRetard"></span>
            </div>
            <h3 class="text-sm opacity-90 mb-1">Factures Impayées</h3>
            <p class="text-3xl font-bold font-poppins" x-text="formatMoney(stats.facturesImpayees)"></p>
        </div>
    </div>
    
    <!-- Actions Rapides -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <button @click="showFactureModal = true"
                class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition border-2 border-gray-200 dark:border-gray-700">
            <i data-lucide="file-plus" class="w-8 h-8 text-blue-600 dark:text-blue-400 mx-auto mb-2"></i>
            <p class="font-semibold text-gray-900 dark:text-white">Nouvelle Facture</p>
        </button>
        
        <button @click="showDepenseModal = true"
                class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition border-2 border-gray-200 dark:border-gray-700">
            <i data-lucide="credit-card" class="w-8 h-8 text-red-600 dark:text-red-400 mx-auto mb-2"></i>
            <p class="font-semibold text-gray-900 dark:text-white">Enregistrer Dépense</p>
        </button>
        
        <button @click="generateReport()"
                class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition border-2 border-gray-200 dark:border-gray-700">
            <i data-lucide="file-bar-chart" class="w-8 h-8 text-purple-600 dark:text-purple-400 mx-auto mb-2"></i>
            <p class="font-semibold text-gray-900 dark:text-white">Rapport Financier</p>
        </button>
        
        <button @click="exportCompta()"
                class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition border-2 border-gray-200 dark:border-gray-700">
            <i data-lucide="download" class="w-8 h-8 text-green-600 dark:text-green-400 mx-auto mb-2"></i>
            <p class="font-semibold text-gray-900 dark:text-white">Export Comptable</p>
        </button>
    </div>
    
    <!-- Contenu Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <!-- Factures -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-walee-dark dark:text-white">Factures Récentes</h3>
                <select x-model="factureFilter" 
                        class="text-sm px-3 py-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
                    <option value="">Toutes</option>
                    <option value="payee">Payées</option>
                    <option value="attente">En attente</option>
                    <option value="retard">En retard</option>
                </select>
            </div>
            
            <div class="space-y-3">
                <template x-for="facture in filteredFactures" :key="facture.id">
                    <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white" x-text="facture.numero"></p>
                                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="facture.client"></p>
                            </div>
                            <span class="inline-flex px-3 py-1 rounded-full text-xs font-medium"
                                  :class="getFactureStatusClass(facture.statut)">
                                <span x-text="facture.statut"></span>
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="font-bold text-gray-900 dark:text-white" x-text="formatMoney(facture.montant)"></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400" x-text="'Échéance: ' + facture.echeance"></p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Dépenses -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-walee-dark dark:text-white">Dépenses Récentes</h3>
                <select x-model="depenseFilter" 
                        class="text-sm px-3 py-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
                    <option value="">Toutes</option>
                    <option value="achat">Achats</option>
                    <option value="salaire">Salaires</option>
                    <option value="autre">Autres</option>
                </select>
            </div>
            
            <div class="space-y-3">
                <template x-for="depense in filteredDepenses" :key="depense.id">
                    <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center"
                                     :class="getDepenseIconClass(depense.categorie)">
                                    <i :data-lucide="getDepenseIcon(depense.categorie)" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900 dark:text-white" x-text="depense.libelle"></p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400" x-text="depense.categorie"></p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="font-bold text-red-600 dark:text-red-400" x-text="formatMoney(depense.montant)"></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400" x-text="depense.date"></p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
    </div>
    
    <!-- Trésorerie -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm mb-6">
        <h3 class="text-lg font-bold text-walee-dark dark:text-white mb-6">Trésorerie</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Solde Banque</p>
                    <i data-lucide="building" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                </div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="formatMoney(tresorerie.banque)"></p>
            </div>
            
            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Caisse</p>
                    <i data-lucide="wallet" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                </div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="formatMoney(tresorerie.caisse)"></p>
            </div>
            
            <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-200 dark:border-purple-800">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Total Disponible</p>
                    <i data-lucide="coins" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                </div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="formatMoney(tresorerie.total)"></p>
            </div>
        </div>
    </div>
    
    <!-- Rapprochement Bancaire -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-bold text-walee-dark dark:text-white">Rapprochement Bancaire</h3>
            <button class="px-4 py-2 bg-walee-blue text-white rounded-lg hover:bg-blue-700 transition">
                <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                Rapprocher
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Libellé</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Débit</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Crédit</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Statut</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="transaction in transactions" :key="transaction.id">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300" x-text="transaction.date"></td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white font-medium" x-text="transaction.libelle"></td>
                            <td class="px-4 py-3 text-sm text-right text-red-600 dark:text-red-400" x-text="transaction.debit ? formatMoney(transaction.debit) : '-'"></td>
                            <td class="px-4 py-3 text-sm text-right text-green-600 dark:text-green-400" x-text="transaction.credit ? formatMoney(transaction.credit) : '-'"></td>
                            <td class="px-4 py-3 text-center">
                                <span class="inline-flex px-2 py-1 rounded-full text-xs font-medium"
                                      :class="transaction.rapproche ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' : 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300'">
                                    <span x-text="transaction.rapproche ? 'Rapproché' : 'En attente'"></span>
                                </span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
function comptableData() {
    return {
        selectedPeriod: 'month',
        factureFilter: '',
        depenseFilter: '',
        showFactureModal: false,
        showDepenseModal: false,
        
        stats: {
            ca: 12500000,
            depenses: 8200000,
            benefice: 4300000,
            facturesImpayees: 2100000,
            facturesEnRetard: 3
        },
        
        tresorerie: {
            banque: 15600000,
            caisse: 2400000,
            total: 18000000
        },
        
        factures: [
            { id: 1, numero: 'FAC-2024-001', client: 'ACME Corp', montant: 850000, statut: 'Payée', echeance: '15/01/2024' },
            { id: 2, numero: 'FAC-2024-002', client: 'Tech Boutique', montant: 650000, statut: 'En attente', echeance: '20/01/2024' },
            { id: 3, numero: 'FAC-2024-003', client: 'Restaurant Saveurs', montant: 450000, statut: 'En retard', echeance: '10/01/2024' },
            { id: 4, numero: 'FAC-2024-004', client: 'Marie Kouassi', montant: 125000, statut: 'Payée', echeance: '18/01/2024' }
        ],
        
        depenses: [
            { id: 1, libelle: 'Achat stock électronique', categorie: 'Achats', montant: 2500000, date: 'Aujourd\'hui' },
            { id: 2, libelle: 'Salaires Janvier', categorie: 'Salaires', montant: 1800000, date: 'Hier' },
            { id: 3, libelle: 'Loyer boutique', categorie: 'Autres', montant: 500000, date: 'Il y a 2j' },
            { id: 4, libelle: 'Électricité', categorie: 'Autres', montant: 150000, date: 'Il y a 3j' }
        ],
        
        transactions: [
            { id: 1, date: '15/01/2024', libelle: 'Virement client ACME', debit: 0, credit: 850000, rapproche: true },
            { id: 2, date: '14/01/2024', libelle: 'Paiement fournisseur', debit: 2500000, credit: 0, rapproche: true },
            { id: 3, date: '13/01/2024', libelle: 'Virement salaires', debit: 1800000, credit: 0, rapproche: false },
            { id: 4, date: '12/01/2024', libelle: 'Encaissement ventes', debit: 0, credit: 1200000, rapproche: true }
        ],
        
        get filteredFactures() {
            if (!this.factureFilter) return this.factures;
            return this.factures.filter(f => f.statut.toLowerCase().includes(this.factureFilter));
        },
        
        get filteredDepenses() {
            if (!this.depenseFilter) return this.depenses;
            return this.depenses.filter(d => d.categorie.toLowerCase() === this.depenseFilter);
        },
        
        loadData() {
            console.log('Chargement données:', this.selectedPeriod);
        },
        
        getFactureStatusClass(statut) {
            const classes = {
                'Payée': 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
                'En attente': 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300',
                'En retard': 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'
            };
            return classes[statut] || 'bg-gray-100 text-gray-700';
        },
        
        getDepenseIconClass(categorie) {
            const classes = {
                'Achats': 'bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400',
                'Salaires': 'bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400',
                'Autres': 'bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-400'
            };
            return classes[categorie] || 'bg-gray-100 text-gray-600';
        },
        
        getDepenseIcon(categorie) {
            const icons = {
                'Achats': 'shopping-cart',
                'Salaires': 'users',
                'Autres': 'file-text'
            };
            return icons[categorie] || 'circle';
        },
        
        generateReport() {
            alert('📊 Génération du rapport financier...\n\nFonctionnalité à venir');
        },
        
        exportCompta() {
            alert('📥 Export comptable\n\nFormat: Excel\nFonctionnalité à venir');
        },
        
        formatMoney(amount) {
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M FCFA';
            }
            return new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';
        }
    }
}
</script>
{% endblock %}
