{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block title %}Statistiques - Walee{% endblock %}

{% block dashboard_content %}
<div x-data="statistiquesData()">
    
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold font-poppins text-walee-dark dark:text-white mb-2">
                Statistiques & Rapports
            </h1>
            <p class="text-gray-600 dark:text-gray-400">Analysez vos performances en d√©tail</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <select x-model="selectedPeriod" 
                    @change="loadStats()"
                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-walee-blue outline-none">
                <option value="week">Cette semaine</option>
                <option value="month">Ce mois</option>
                <option value="quarter">Ce trimestre</option>
                <option value="year">Cette ann√©e</option>
            </select>
            <button @click="showExportModal = true" 
                    class="flex items-center space-x-2 px-6 py-2 bg-walee-blue text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                <i data-lucide="download" class="w-5 h-5"></i>
                <span class="hidden sm:inline">Exporter</span>
            </button>
        </div>
    </div>
    
    <!-- Filtre Entreprise -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-6 shadow-sm">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <label class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">Entreprise:</label>
            <select x-model="selectedEntreprise" 
                    @change="loadStats()"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-walee-blue outline-none">
                <option value="">üìä Toutes les entreprises</option>
                <option value="1">üè¢ ACME Corporation</option>
                <option value="2">üíª Tech Boutique</option>
                <option value="3">üçΩÔ∏è Restaurant Saveurs</option>
            </select>
        </div>
    </div>
    
    <!-- KPIs Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
        
        <!-- Chiffre d'affaires -->
        <div class="bg-gradient-to-br from-walee-blue to-walee-indigo rounded-2xl p-6 text-white shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                </div>
                <span class="text-sm font-medium bg-white/20 px-3 py-1 rounded-full">+15.3%</span>
            </div>
            <h3 class="text-sm opacity-90 mb-1">Chiffre d'affaires</h3>
            <p class="text-2xl md:text-3xl font-bold font-poppins" x-text="formatMoney(stats.ca)"></p>
            <p class="text-xs opacity-75 mt-1">vs p√©riode pr√©c√©dente</p>
        </div>
        
        <!-- Ventes -->
        <div class="bg-gradient-to-br from-walee-green to-emerald-600 rounded-2xl p-6 text-white shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                </div>
                <span class="text-sm font-medium bg-white/20 px-3 py-1 rounded-full">+8.2%</span>
            </div>
            <h3 class="text-sm opacity-90 mb-1">Nombre de ventes</h3>
            <p class="text-2xl md:text-3xl font-bold font-poppins" x-text="stats.ventes"></p>
            <p class="text-xs opacity-75 mt-1">transactions r√©alis√©es</p>
        </div>
        
        <!-- Clients -->
        <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-6 text-white shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="users" class="w-6 h-6"></i>
                </div>
                <span class="text-sm font-medium bg-white/20 px-3 py-1 rounded-full">+12</span>
            </div>
            <h3 class="text-sm opacity-90 mb-1">Nouveaux clients</h3>
            <p class="text-2xl md:text-3xl font-bold font-poppins" x-text="stats.nouveauxClients"></p>
            <p class="text-xs opacity-75 mt-1">cette p√©riode</p>
        </div>
        
        <!-- Panier moyen -->
        <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl p-6 text-white shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                </div>
                <span class="text-sm font-medium bg-white/20 px-3 py-1 rounded-full">+5.7%</span>
            </div>
            <h3 class="text-sm opacity-90 mb-1">Panier moyen</h3>
            <p class="text-2xl md:text-3xl font-bold font-poppins" x-text="formatMoney(stats.panierMoyen)"></p>
            <p class="text-xs opacity-75 mt-1">par transaction</p>
        </div>
        
    </div>
    
    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6">
        
        <!-- Evolution CA -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold font-poppins text-walee-dark dark:text-white">√âvolution du CA</h3>
                <div class="flex space-x-2">
                    <button @click="updateChartType('line')" 
                            :class="chartType === 'line' ? 'bg-walee-blue text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'"
                            class="p-2 rounded-lg transition-colors">
                        <i data-lucide="line-chart" class="w-4 h-4"></i>
                    </button>
                    <button @click="updateChartType('bar')" 
                            :class="chartType === 'bar' ? 'bg-walee-blue text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'"
                            class="p-2 rounded-lg transition-colors">
                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            <div class="h-64">
                <canvas id="caChart"></canvas>
            </div>
        </div>
        
        <!-- R√©partition par cat√©gorie -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-bold font-poppins text-walee-dark dark:text-white mb-6">Ventes par cat√©gorie</h3>
            <div class="h-64">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
        
    </div>
    
    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-6">
        
        <!-- Top Produits -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-bold font-poppins text-walee-dark dark:text-white mb-6">Top 5 Produits</h3>
            <div class="space-y-4">
                <template x-for="(produit, index) in topProduits" :key="index">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm flex-shrink-0"
                             :class="index === 0 ? 'bg-yellow-500' : index === 1 ? 'bg-gray-400' : index === 2 ? 'bg-orange-600' : 'bg-gray-300 dark:bg-gray-600'">
                            <span x-text="index + 1"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 dark:text-white truncate text-sm" x-text="produit.nom"></p>
                            <p class="text-xs text-gray-500 dark:text-gray-400" x-text="produit.ventes + ' ventes'"></p>
                        </div>
                        <p class="font-semibold text-walee-dark dark:text-white text-sm whitespace-nowrap" x-text="formatMoney(produit.ca, true)"></p>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Performance par vendeur -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-bold font-poppins text-walee-dark dark:text-white mb-6">Top Vendeurs</h3>
            <div class="space-y-4">
                <template x-for="(vendeur, index) in topVendeurs" :key="index">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold flex-shrink-0"
                             :class="vendeur.gradient">
                            <span x-text="vendeur.initiales"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 dark:text-white text-sm" x-text="vendeur.nom"></p>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="bg-walee-green rounded-full h-2 transition-all duration-300" 
                                         :style="`width: ${vendeur.performance}%`"></div>
                                </div>
                                <span class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap" x-text="vendeur.performance + '%'"></span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Heures de pointe -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-bold font-poppins text-walee-dark dark:text-white mb-6">Heures de pointe</h3>
            <div class="space-y-3">
                <template x-for="heure in heuresPointe" :key="heure.time">
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300" x-text="heure.time"></span>
                            <span class="text-sm text-gray-500 dark:text-gray-400" x-text="heure.ventes + ' ventes'"></span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="rounded-full h-2 transition-all duration-300"
                                 :class="heure.ventes > 15 ? 'bg-walee-green' : heure.ventes > 10 ? 'bg-blue-500' : 'bg-gray-400'"
                                 :style="`width: ${(heure.ventes / 20) * 100}%`"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
    </div>
    
    <!-- Tableau comparatif entreprises -->
    <div x-show="!selectedEntreprise" x-transition class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-bold font-poppins text-walee-dark dark:text-white">Comparatif par entreprise</h3>
        </div>
        
        <!-- Version Desktop -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Entreprise</th>
                        <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">CA</th>
                        <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Ventes</th>
                        <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Panier Moyen</th>
                        <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">√âvolution</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="entreprise in entreprisesStats" :key="entreprise.id">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold"
                                         :class="entreprise.gradient">
                                        <span x-text="entreprise.initiales"></span>
                                    </div>
                                    <span class="font-medium text-gray-900 dark:text-white" x-text="entreprise.nom"></span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right font-semibold text-gray-900 dark:text-white" x-text="formatMoney(entreprise.ca)"></td>
                            <td class="px-6 py-4 text-right text-gray-700 dark:text-gray-300" x-text="entreprise.ventes"></td>
                            <td class="px-6 py-4 text-right text-gray-700 dark:text-gray-300" x-text="formatMoney(entreprise.panierMoyen)"></td>
                            <td class="px-6 py-4 text-right">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                                      :class="entreprise.evolution > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'">
                                    <i :data-lucide="entreprise.evolution > 0 ? 'trending-up' : 'trending-down'" class="w-3 h-3 mr-1"></i>
                                    <span x-text="(entreprise.evolution > 0 ? '+' : '') + entreprise.evolution + '%'"></span>
                                </span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Version Mobile -->
        <div class="md:hidden p-4 space-y-4">
            <template x-for="entreprise in entreprisesStats" :key="entreprise.id">
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold"
                             :class="entreprise.gradient">
                            <span x-text="entreprise.initiales"></span>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-900 dark:text-white" x-text="entreprise.nom"></h4>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                  :class="entreprise.evolution > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'">
                                <span x-text="(entreprise.evolution > 0 ? '+' : '') + entreprise.evolution + '%'"></span>
                            </span>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">CA</p>
                            <p class="font-semibold text-sm text-gray-900 dark:text-white" x-text="formatMoney(entreprise.ca, true)"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Ventes</p>
                            <p class="font-semibold text-sm text-gray-900 dark:text-white" x-text="entreprise.ventes"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">P. Moyen</p>
                            <p class="font-semibold text-sm text-gray-900 dark:text-white" x-text="formatMoney(entreprise.panierMoyen, true)"></p>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Insights & Recommandations -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
        
        <!-- Insights -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-bold font-poppins text-walee-dark dark:text-white mb-4">üìä Insights</h3>
            <div class="space-y-3">
                <div class="flex items-start space-x-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-900/30">
                    <i data-lucide="trending-up" class="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Croissance soutenue</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Vos ventes ont augment√© de 15% ce mois</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-100 dark:border-green-900/30">
                    <i data-lucide="users" class="w-5 h-5 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Acquisition clients</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">12 nouveaux clients cette semaine</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-100 dark:border-purple-900/30">
                    <i data-lucide="clock" class="w-5 h-5 text-purple-600 dark:text-purple-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Pic d'activit√©</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">14h-16h sont vos heures les plus actives</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recommandations -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h3 class="text-lg font-bold font-poppins text-walee-dark dark:text-white mb-4">üí° Recommandations</h3>
            <div class="space-y-3">
                <div class="flex items-start space-x-3 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-100 dark:border-orange-900/30">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-orange-600 dark:text-orange-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Stock √† surveiller</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">3 produits en rupture de stock</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-100 dark:border-yellow-900/30">
                    <i data-lucide="file-text" class="w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Factures en retard</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">2 factures √† relancer</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-100 dark:border-indigo-900/30">
                    <i data-lucide="zap" class="w-5 h-5 text-indigo-600 dark:text-indigo-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Opportunit√©</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Promouvoir les produits populaires</p>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Modal Export -->
    <div x-show="showExportModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
         @click.self="showExportModal = false"
         style="display: none;">
        
        <div x-show="showExportModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-90"
             x-transition:enter-end="opacity-100 scale-100"
             class="bg-white dark:bg-gray-800 rounded-2xl max-w-lg w-full shadow-2xl">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-walee-blue to-walee-indigo px-6 py-4 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold font-poppins text-white">Exporter les donn√©es</h2>
                    <button @click="showExportModal = false" 
                            class="p-2 hover:bg-white/20 rounded-lg transition">
                        <i data-lucide="x" class="w-6 h-6 text-white"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                
                <!-- Format -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                        Format d'export
                    </label>
                    <div class="grid grid-cols-3 gap-3">
                        <button type="button"
                                @click="exportFormat = 'pdf'"
                                :class="exportFormat === 'pdf' ? 'bg-walee-blue text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                class="flex flex-col items-center p-4 rounded-xl transition hover:scale-105">
                            <i data-lucide="file-text" class="w-8 h-8 mb-2"></i>
                            <span class="text-sm font-medium">PDF</span>
                        </button>
                        <button type="button"
                                @click="exportFormat = 'excel'"
                                :class="exportFormat === 'excel' ? 'bg-walee-green text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                class="flex flex-col items-center p-4 rounded-xl transition hover:scale-105">
                            <i data-lucide="file-spreadsheet" class="w-8 h-8 mb-2"></i>
                            <span class="text-sm font-medium">Excel</span>
                        </button>
                        <button type="button"
                                @click="exportFormat = 'csv'"
                                :class="exportFormat === 'csv' ? 'bg-purple-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                class="flex flex-col items-center p-4 rounded-xl transition hover:scale-105">
                            <i data-lucide="file" class="w-8 h-8 mb-2"></i>
                            <span class="text-sm font-medium">CSV</span>
                        </button>
                    </div>
                </div>
                
                <!-- Donn√©es √† exporter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                        Donn√©es √† inclure
                    </label>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                            <input type="checkbox" 
                                   x-model="exportData.ventes"
                                   class="w-4 h-4 text-walee-blue rounded focus:ring-walee-blue">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Ventes</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                            <input type="checkbox" 
                                   x-model="exportData.clients"
                                   class="w-4 h-4 text-walee-blue rounded focus:ring-walee-blue">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Clients</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                            <input type="checkbox" 
                                   x-model="exportData.produits"
                                   class="w-4 h-4 text-walee-blue rounded focus:ring-walee-blue">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Produits</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                            <input type="checkbox" 
                                   x-model="exportData.statistiques"
                                   class="w-4 h-4 text-walee-blue rounded focus:ring-walee-blue">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Statistiques</span>
                        </label>
                    </div>
                </div>
                
                <!-- P√©riode -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        P√©riode
                    </label>
                    <select x-model="exportPeriod" 
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-walee-blue outline-none">
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="quarter">Ce trimestre</option>
                        <option value="year">Cette ann√©e</option>
                        <option value="all">Toutes les donn√©es</option>
                    </select>
                </div>
                
            </div>
            
            <!-- Actions -->
            <div class="flex space-x-3 px-6 pb-6">
                <button type="button" 
                        @click="showExportModal = false"
                        class="flex-1 px-6 py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    Annuler
                </button>
                <button type="button" 
                        @click="handleExport()"
                        class="flex-1 px-6 py-3 bg-walee-blue text-white font-semibold rounded-xl hover:bg-blue-700 transition flex items-center justify-center space-x-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span>Exporter</span>
                </button>
            </div>
            
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
// Configuration globale Chart.js - animations d√©sactiv√©es
Chart.defaults.animation = false;
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;

function statistiquesData() {
    return {
        selectedPeriod: 'month',
        selectedEntreprise: '',
        chartType: 'line',
        caChart: null,
        categoryChart: null,
        
        // Modal Export
        showExportModal: false,
        exportFormat: 'pdf',
        exportPeriod: 'month',
        exportData: {
            ventes: true,
            clients: true,
            produits: false,
            statistiques: true
        },
        
        stats: {
            ca: 12500000,
            ventes: 456,
            nouveauxClients: 45,
            panierMoyen: 85000
        },
        
        topProduits: [
            { nom: 'Laptop HP Pavilion', ventes: 45, ca: 20250000 },
            { nom: 'iPhone 13 Pro', ventes: 38, ca: 24700000 },
            { nom: 'Samsung Galaxy S23', ventes: 32, ca: 17600000 },
            { nom: 'MacBook Air M2', ventes: 28, ca: 25200000 },
            { nom: 'iPad Pro', ventes: 25, ca: 15000000 }
        ],
        
        topVendeurs: [
            { nom: 'Marie Martin', initiales: 'MM', performance: 95, gradient: 'bg-gradient-to-br from-walee-blue to-walee-indigo' },
            { nom: 'Jean Dupont', initiales: 'JD', performance: 88, gradient: 'bg-gradient-to-br from-purple-500 to-pink-600' },
            { nom: 'Sophie Laurent', initiales: 'SL', performance: 82, gradient: 'bg-gradient-to-br from-green-500 to-emerald-600' },
            { nom: 'Pierre Dubois', initiales: 'PD', performance: 75, gradient: 'bg-gradient-to-br from-orange-500 to-red-600' }
        ],
        
        heuresPointe: [
            { time: '09h-11h', ventes: 12 },
            { time: '11h-13h', ventes: 18 },
            { time: '13h-15h', ventes: 8 },
            { time: '15h-17h', ventes: 20 },
            { time: '17h-19h', ventes: 15 }
        ],
        
        entreprisesStats: [
            { id: 1, nom: 'ACME Corporation', initiales: 'AC', ca: 5200000, ventes: 156, panierMoyen: 33333, evolution: 15.3, gradient: 'bg-gradient-to-br from-walee-blue to-walee-indigo' },
            { id: 2, nom: 'Tech Boutique', initiales: 'TB', ca: 4100000, ventes: 89, panierMoyen: 46067, evolution: 8.7, gradient: 'bg-gradient-to-br from-purple-500 to-pink-600' },
            { id: 3, nom: 'Restaurant Saveurs', initiales: 'RS', ca: 3200000, ventes: 234, panierMoyen: 13675, evolution: -2.1, gradient: 'bg-gradient-to-br from-orange-500 to-red-600' }
        ],
        
        init() {
            this.$nextTick(() => {
                this.initCharts();
            });
        },
        
        initCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#9CA3AF' : '#6B7280';
            const gridColor = isDark ? '#374151' : '#E5E7EB';
            
            // CA Chart
            const caCtx = document.getElementById('caChart');
            if (caCtx) {
                this.caChart = new Chart(caCtx, {
                    type: this.chartType,
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'CA (FCFA)',
                            data: [1200000, 1900000, 1500000, 2100000, 1800000, 2400000, 2000000],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => (ctx.parsed.y / 1000000).toFixed(1) + 'M FCFA'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: gridColor },
                                ticks: {
                                    color: textColor,
                                    callback: (val) => (val / 1000000).toFixed(1) + 'M'
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: textColor }
                            }
                        }
                    }
                });
            }
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                this.categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['√âlectronique', 'V√™tements', 'Alimentation', 'Autres'],
                        datasets: [{
                            data: [45, 25, 20, 10],
                            backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: textColor,
                                    padding: 12,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.label + ': ' + ctx.parsed + '%'
                                }
                            }
                        },
                        cutout: '65%'
                    }
                });
            }
        },
        
        updateChartType(type) {
            this.chartType = type;
            if (this.caChart) {
                this.caChart.destroy();
                const caCtx = document.getElementById('caChart');
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#9CA3AF' : '#6B7280';
                const gridColor = isDark ? '#374151' : '#E5E7EB';
                
                this.caChart = new Chart(caCtx, {
                    type: type,
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'CA (FCFA)',
                            data: [1200000, 1900000, 1500000, 2100000, 1800000, 2400000, 2000000],
                            borderColor: '#3B82F6',
                            backgroundColor: type === 'line' ? 'rgba(59, 130, 246, 0.1)' : '#3B82F6',
                            tension: 0.4,
                            fill: type === 'line',
                            pointRadius: type === 'line' ? 3 : 0
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => (ctx.parsed.y / 1000000).toFixed(1) + 'M FCFA'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: gridColor },
                                ticks: {
                                    color: textColor,
                                    callback: (val) => (val / 1000000).toFixed(1) + 'M'
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: textColor }
                            }
                        }
                    }
                });
            }
        },
        
        loadStats() {
            console.log('Chargement stats:', this.selectedPeriod, this.selectedEntreprise);
        },
        
        handleExport() {
            // V√©rifier qu'au moins une donn√©e est s√©lectionn√©e
            const hasData = Object.values(this.exportData).some(val => val === true);
            
            if (!hasData) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un type de donn√©es √† exporter');
                return;
            }
            
            // Pr√©parer les donn√©es s√©lectionn√©es
            const selectedData = [];
            if (this.exportData.ventes) selectedData.push('Ventes');
            if (this.exportData.clients) selectedData.push('Clients');
            if (this.exportData.produits) selectedData.push('Produits');
            if (this.exportData.statistiques) selectedData.push('Statistiques');
            
            alert(`‚úÖ Export en cours...\n\nFormat: ${this.exportFormat.toUpperCase()}\nDonn√©es: ${selectedData.join(', ')}\nP√©riode: ${this.exportPeriod}\n\nFonctionnalit√© √† venir`);
            
            this.showExportModal = false;
        },
        
        formatMoney(amount, short = false) {
            if (short && amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M';
            }
            return new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';
        }
    }
}
</script>
{% endblock %}